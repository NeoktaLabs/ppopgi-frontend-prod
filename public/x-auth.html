<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ppopgi â€” Start X Auth</title>
    <style>
      body{font-family:system-ui;background:#0b1220;color:#e5e7eb;margin:0}
      .wrap{max-width:720px;margin:48px auto;padding:0 16px}
      .card{background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px}
      input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:#e5e7eb}
      label{display:block;margin:10px 0 6px;font-size:12px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:#9ca3af}
      button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:900;background:#60a5fa;color:#06121f}
      .muted{color:#9ca3af;font-size:13px}
      code{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:block;margin-top:10px;overflow:auto}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1 style="margin:0 0 8px 0;">Start X OAuth (PKCE)</h1>
      <div class="muted">Use this once to authorize your Ppopgi X account.</div>

      <div class="card" style="margin-top:16px;">
        <label>X Client ID</label>
        <input id="clientId" placeholder="your client_id" />

        <label>Redirect URI</label>
        <input id="redirectUri" value="https://YOUR_DOMAIN/x-callback.html" />

        <label>Scopes</label>
        <input id="scopes" value="tweet.write users.read offline.access" />

        <div style="margin-top:14px;">
          <button id="go">Authorize with X</button>
        </div>

        <div class="muted" style="margin-top:12px;">
          This stores the PKCE <b>code_verifier</b> in localStorage so the callback page can read it.
        </div>

        <code id="debug" style="display:none;"></code>
      </div>
    </div>

    <script>
      // base64url helpers
      const b64url = (buf) =>
        btoa(String.fromCharCode(...new Uint8Array(buf)))
          .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");

      function randString(len=64) {
        const bytes = new Uint8Array(len);
        crypto.getRandomValues(bytes);
        return b64url(bytes).slice(0, 96);
      }

      async function sha256(str) {
        const data = new TextEncoder().encode(str);
        return await crypto.subtle.digest("SHA-256", data);
      }

      document.getElementById("go").addEventListener("click", async () => {
        const clientId = document.getElementById("clientId").value.trim();
        const redirectUri = document.getElementById("redirectUri").value.trim();
        const scopes = document.getElementById("scopes").value.trim();

        if (!clientId) return alert("Missing client_id");
        if (!redirectUri) return alert("Missing redirect_uri");

        const state = randString(24);
        const codeVerifier = randString(64);
        const challenge = b64url(await sha256(codeVerifier));

        localStorage.setItem("ppopgi_x_state", state);
        localStorage.setItem("ppopgi_x_code_verifier", codeVerifier);

        const url = new URL("https://x.com/i/oauth2/authorize");
        url.searchParams.set("response_type", "code");
        url.searchParams.set("client_id", clientId);
        url.searchParams.set("redirect_uri", redirectUri);
        url.searchParams.set("scope", scopes);
        url.searchParams.set("state", state);
        url.searchParams.set("code_challenge", challenge);
        url.searchParams.set("code_challenge_method", "S256");

        location.href = url.toString();
      });
    </script>
  </body>
</html>